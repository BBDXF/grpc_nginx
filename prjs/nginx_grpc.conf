worker_processes auto;
error_log /tmp/nginx_error.log info;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /tmp/nginx_access.log main;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # 服务器配置
    server {
        listen 9000 http2;
        server_name _;

        # 允许 h2c 升级（部分客户端需要）
        # add_header Upgrade "h2c" always;
        # add_header Connection "Upgrade" always;

        # 1. 静态文件服务（/files）
        location ^~ /files {  # ^~ 表示前缀匹配，优先级高于正则
            alias /home/andy/myrpc;
            autoindex on;
            index index.html index.htm;
            expires 1d;
        }

        # 2. 首页（/）
        location = / {  # 精确匹配首页，优先级最高
            default_type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>默认页面</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        h1 { color: #333; }
        p { color: #666; font-size: 1.2em; }
    </style>
</head>
<body>
    <h1>欢迎访问服务</h1>
    <p>这是默认页面，请求未匹配到任何特定路径</p>
</body>
</html>';
        }

        # 3. GRPC 服务（正则匹配，优先级低于前缀匹配）
        location ~* /andy\.robot/ {  # 转义 . 避免匹配任意字符（关键修复）
            grpc_pass grpc://127.0.0.1:9091;
            grpc_set_header Host $host;
            grpc_set_header X-Real-IP $remote_addr;
        }

        location ~* /andy\.greeter/ {  # 转义 . 避免误匹配
            grpc_pass grpc://127.0.0.1:9090;
            grpc_set_header Host $host;
            grpc_set_header X-Real-IP $remote_addr;
        }

        # 错误页面配置
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }

}
